---
title: "511 - Industry data - plotting trend plots from medians, 2021 data"
output: html_document
---

## 0. -- COMMON CODE ---  
This code is used by teh parts for each area below  

### Packages
```{r, message=FALSE, warning=FALSE, results='hide'}

# 
library(readxl)
library(tidyr)
library(dplyr, warn.conflicts = FALSE)
library(purrr)
library(lubridate)
library(mgcv)
library(AICcmodavg)   # AICc()
library(ggplot2)
library(safejoin)     # installed from https://github.com/moodymudskipper/safejoin   

source("001_Add_trends_functions.R")  # Copied from '16_Trend_functions.R' in Milkys_2018
source("002_Utility_functions.R")
source("110_Medians_and_PROREF_functions.R")
source("510_Industry_data_functions.R")
source("401 Plot time series functions.R", encoding = "UTF-8")

last_year <- 2021


#
# Define a couple of extra functions for shortening code
#
get_stats <- function(df){
  calc_models_one_station2(df, gam = TRUE, log = TRUE)$statistics_for_file
}

model_from_medians_stat <- function(...)
  model_from_medians(...)$statistics

```

### Parameter and species names for graphs
Used in 'plot_single_series_medians_data' (see '_functions' file)  
```{r}

df_paramnames <- readxl::read_excel(
  "Input_data/Lookup table - parameter names for plots.xlsx")

df_speciesnames <- tibble(
  LATIN_NAME = c("Gadus morhua", "Mytilus edulis", "Nucella lapillus"),
  Species_name = c("Cod", "Blue mussel", "Dog whelk")
  )

```

### PROREF values  
```{r}
df_proref <- get_proref(folder = "Input_data")


```


### Get EQS limits  
```{r}

df_EQS <- read_excel("Input_data/EQS_limits.xlsx", "EQS")[1:8] %>%
  filter(!is.na(PARAM)) %>%
  as.data.frame()
df_EQS <- fact2char_df(df_EQS)  # changes all factor variables to character variables
df_EQS$Limit <- as.numeric(df_EQS$`Grense brukt`)

df_EQS <- df_EQS %>%
  select(PARAM, Limit) %>% 
  filter(!is.na(PARAM))

```



## .
## -- RANFJORDEN -- 
## .


## 1a. Read median data    
From script 02 in 'NIVA-R-examples' project  
```{r}

data_med_temp <- readRDS(
  "Input_data/510_Industry_data/data_chem_industry_ranfjorden_med_2021.rds") %>%
  rename(N_median = N)
  
# names(data_med_temp)
unique(data_med_temp$Basis)   # DW  DWa   FB  FBa   WW  WWa 


```


### Add Proref values    
```{r}

data_med <- data_med_temp %>%
  left_join(df_proref %>% select(-N) %>% rename(Proref_median = Median), 
            by = c("LATIN_NAME", "TISSUE_NAME", "PARAM", "Basis"))

```


## 1b. Time trend analysis   

### Testing trend analysis   
Including simple plot  
```{r}

# table(data_med$STATION_CODE)

data_med_temp$STATION_CODE %>% table()

model_from_medians("PAH16", "Mytilus edulis", "Whole soft body", 
                   "I964b", "WW", 2015:2020, data_med, plotname = "window", 
                   ggplot = TRUE)$statistics %>%
  select(Nplus, p_linear:Status)

```



## 1c. Get ready for plotting     

```{r}

data_med_temp %>%
  count(STATION_CODE, STATION_NAME)

```

### Station names  
```{r}

#
# Hand-made
#

if (FALSE){
  
  # Årdal version  
  df_stationnames <- data.frame(
    STATION_CODE = c("G1B", "G2B", "G5B", "G6B", "G7", "G8"),
    Report_version_name = c("Hundshammar (G1)", "Saltviki (G2)", "Kolnosi (G5)",
                            "Naddvik (G6)", "Kvitingsagi (G7)", "Ytre Offerdal (G8)"),
    stringsAsFactors = FALSE)
  
}

#
# Automatic
#

df_stationnames <- data_med_temp %>%
  filter(!is.na(STATION_NAME)) %>%
  distinct(STATION_CODE, STATION_NAME) %>%
  rename(Report_version_name = STATION_NAME)

df_stationnames

```



### Test 1
```{r}
# debugonce(model_from_medians)
# debugonce(statistics_for_excel)

X <- model_from_medians("BAP", "Mytilus edulis", "Whole soft body", "I964b", "WW", 
                                        2000:2021,  
                                        data_medians = data_med, 
                                        ggplot = TRUE)
X$statistics

```


### Test 2
```{r}

source("401 Plot time series functions.R")
type <- "line"

# debugonce(plot_medians_and_trends2)


# 'xlim' used to extend x axis
# 'eqs_x' used to move 'EQS' label   
#    see script '401 Plot time series functions.R' function 'plot_medians_color'
#    for options  
X <- plot_medians_and_trends2(c("BAP", "Mytilus edulis", "Whole soft body", "I964b", "WW"), 
                         eqs_type = "line", xlim = c(1997, 2022.5),  
                         data_medians = data_med, data_proref = df_proref, 
                         data_eqs = df_EQS, 
                         eqs_x = 2021.5)


save_trendplot(X, "Input_data/510_Industry_data/Plots_Ranfjorden_2021")
X$gg


```


## 1d. All plots   

### Select series (parameter + station) to plot  
```{r}

tab <- xtabs(~ PARAM + STATION_CODE, data_med)
# tab


df_series <- data_med %>%
  count(PARAM, STATION_CODE) %>%
  filter(n >= 2)      # pick stations with at least 2 years of data



```

## 1e. Plot all (using defaults)  

```{r}

folder <- "Input_data/510_Industry_data/Plots_Ranfjorden_2021"

# All 95 plots
for (i in seq_len(nrow(df_series))){

  # For testing (make only plots 1 to 4), comment out the line above and uncomment the next line:
  # for (i in 1:4){
  
  X <- try(
    plot_medians_and_trends2(c(df_series$PARAM[i], "Mytilus edulis", "Whole soft body", 
                               df_series$STATION_CODE[i], "WW"), 
                             eqs_type = "line", xlim = c(1997, 2022.5), 
                             data_medians = data_med, data_proref = df_proref, 
                             data_eqs = df_EQS,
                             eqs_x = 2021.5)
  )
  if (class(X) != "try-error"){
    save_trendplot(X, folder)
  }
  
}

```



## .
## -- AORDAL -- 
## .


## 1a. Read median data    
From script 02 in 'NIVA-R-examples' project  
```{r}

data_med_temp <- readRDS(
  "Input_data/510_Industry_data/data_chem_industry_årdal_med_2021.rds") %>%
  rename(N_median = N)
  
names(data_med_temp)
unique(data_med_temp$Basis)   # DW  DWa   FB  FBa   WW  WWa 


```


### Add Proref values    
```{r}

data_med <- data_med_temp %>%
  left_join(df_proref %>% select(-N) %>% rename(Proref_median = Median), 
            by = c("LATIN_NAME", "TISSUE_NAME", "PARAM", "Basis"))

```


## 1b. Time trend analysis   

### Testing trend analysis   
Including simple plot  
```{r}

data_med_temp$STATION_CODE %>% table()

model_from_medians("PAH16", "Mytilus edulis", "Whole soft body", 
                   "G1B", "WW", 2015:2020, data_med, plotname = "window", 
                   ggplot = TRUE)$statistics %>%
  select(Nplus, p_linear:Status)

```



## 1c. Get ready for plotting     

```{r}

data_med_temp %>%
  count(STATION_CODE, STATION_NAME)

```

### Station names  
```{r}

#
# Hand-made
#

df_stationnames <- data.frame(
  STATION_CODE = c("G1B", "G2B", "G5B", "G6B", "G7", "G8"),
  Report_version_name = c("Hundshammar (G1)", "Saltviki (G2)", "Kolnosi (G5)",
                          "Naddvik (G6)", "Kvitingsagi (G7)", "Ytre Offerdal (G8)"),
  stringsAsFactors = FALSE)

```



### Test 1
```{r}
# debugonce(model_from_medians)
# debugonce(statistics_for_excel)

X <- model_from_medians("BAP", "Mytilus edulis", "Whole soft body", "G1B", "WW", 
                                        2016:2020,  
                                        data_medians = data_med, 
                                        ggplot = TRUE)
X$statistics

```


### Test 2
```{r}

source("401 Plot time series functions.R")
type <- "line"

# debugonce(plot_medians_and_trends2)

# Show all Proref lines 
X <- plot_medians_and_trends2(c("BAP", "Mytilus edulis", "Whole soft body", "G1B", "WW"), 
                         eqs_type = "line", xlim = c(2004, 2021), ylim = c(0, 290), 
                         data_medians = data_med, data_proref = df_proref, 
                         data_eqs = df_EQS)

# Show only "20x Proref" line (using 'show_proref' parameter)
X <- plot_medians_and_trends2(c("BAP", "Mytilus edulis", "Whole soft body", "G1B", "WW"), 
                         eqs_type = "line", xlim = c(2004, 2021), ylim = c(0, 290), 
                         data_medians = data_med, data_proref = df_proref, 
                         data_eqs = df_EQS,
                         show_proref = 5)


save_trendplot(X, "Input_data/510_Industry_data/Plots_Årdal_2021")
X$gg


```


## 1d. All plots   

### Select series (parameter + station) to plot  
```{r}

tab <- xtabs(~ PARAM + STATION_CODE, data_med)
# tab

df_series <- data_med %>%
  count(PARAM, STATION_CODE) %>%
  filter(n >= 2)      # pick stations with at least 2 years of data



```

## 1e. Plot all (using defaults)  

```{r}

folder <- "Input_data/510_Industry_data/Plots_Årdal_2021"

for (i in seq_len(nrow(df_series))){

  # For testing (make only plots 1 to 4), comment out the line above and uncomment the next line:
  # for (i in 1:4){
  
  X <- try(
    plot_medians_and_trends2(c(df_series$PARAM[i], "Mytilus edulis", "Whole soft body", 
                               df_series$STATION_CODE[i], "WW"), 
                             eqs_type = "line", xlim = c(2004, 2022), 
                             data_medians = data_med, data_proref = df_proref, 
                             data_eqs = df_EQS)
  )
  if (class(X) != "try-error"){
    save_trendplot(X, folder)
  }
  
}

```




