---
title: "Trend figures"
output: html_notebook
---



## 0. Lib and source
```{r}
library(dplyr)
library(purrr)
library(ggplot2)
library(lubridate)
library(openxlsx)
library(mgcv)
library(AICcmodavg)   # AICc()
# font_import(pattern = "Wingdings.ttf")    # if not already installed on your PC
```

### Functions used  
This loads the functions we need
test fra BBE
```{r}
# source("16_Trend_functions.R")
source("001_Add_trends_functions.R")
source("401 Plot time series functions.R", encoding = "UTF-8")
```


## 1. Read data
### a1. Median data produced by script 11    
```{r}

files <- dir("Data", pattern = "110_mediandata_updated_") %>% rev()

cat("Reading the last file downloaded:")
cat("\n", files[1])
cat("\n")
cat("If you want to read a different file, replace 'files[1]' with the file you want")
cat("\n")

filename <- paste0("Data/", files[1]) 

# Medians
data_med2 <- readRDS(file = filename) %>%
  rename(Proref_median = Median,
         Median = Value) 

```


### a2. Add VDSI (Actually Intersex) for 71G 2017   
Is only performed if it is needed.   
```{r}
check <- sum(with(data_med2, PARAM %in% "VDSI/Intersex" & MYEAR == 2018 & STATION_CODE %in% "71G" & Basis %in% "WW"))

check

if (check == 0){   # add only if not already added
  # Copy line to use
  data_extra <- data_med2 %>% 
    filter(PARAM %in% "VDSI" & MYEAR == 2016 & STATION_CODE %in% "71G" & Basis %in% "WW")
  # Change that line
  data_extra$MYEAR <- 2018
  data_extra$Median <- 0    # manual entry of value 
  data_med2 <- rbind(data_med2, data_extra)
  rm(data_extra)
  }
```

```{r}
# library(extrafont)
# font_import(pattern = "Wingdings.ttf")

```

### a3. Read station names  
Used in 'plot_single_series_medians_data' (see '_functions' file)  
```{r}
data_stations <- readxl::read_excel("Input_data/Kartbase.xlsx")

# Note that 
#     the current station code is 'stasjonskode', not "STATION_CODE"
#     `catch LAT__1` and `catch LONG__1` are currect (planned?) positions
#     the current station name is 'stasjonsnavn', not "STATION_CODE"
#     but station name for report is `Til Rapport`
#         station name for maps are `Til Kart`

# Check the two station code columns
# data_stations %>%
#   filter(STATION_CODE != stasjonskode)    # zero rows

df_stationnames <- data_stations %>%
  select(stasjonskode, `catch LAT...40`, `catch LONG...41`, stasjonsnavn, `Til Rapport`) %>%
  rename(STATION_CODE = stasjonskode,
         Lat = `catch LAT...40`, Long = `catch LONG...41`, 
         Station_name = stasjonsnavn,
         Report_version_name = `Til Rapport`) %>%
  filter(!is.na(STATION_CODE)) %>%
  filter(!Station_name %in% "Risøy, Østerfjord")  # One duplicate (different names), we just remove 

# Check stations that might be missing
df_stationnames %>% filter(STATION_CODE %in% c("28A2","97A3","227G","19B","19N"))

# Add missing station
df_stationnames <- df_stationnames %>%
  bind_rows(
    tibble(STATION_CODE = "227G",
           Report_version_name = "Flatskjær (St. 227G)")
    )

# Check some other stations
df_stationnames %>% filter(STATION_CODE %in% c("I714", "I133"))


```

### a4. Parameter names for graphs
Used in 'plot_single_series_medians_data' (see '_functions' file)  
```{r}
df_paramnames <- readxl::read_excel("Input_data/Lookup table - parameter names for plots.xlsx")

```

### a5. Species names for graphs
Used in 'plot_single_series_medians_data' (see '_functions' file)  

```{r}
df_speciesnames <- tibble(
  LATIN_NAME = c("Gadus morhua", "Mytilus edulis", "Nucella lapillus"),
  Species_name = c("Cod", "Blue mussel", "Dog whelk")
  )

```

### a6. Big excel data - file versions   
```{r}
#
# Existing file names (dates and versions)
#
fns <- dir("Big_excel_table", pattern = "Data_xl_.+.rds") %>% rev()
fns_date <- substr(fns, 9, 18)
fns_ver <- stringr::str_extract(fns, "ver[0-9]+") %>% stringr::str_extract("[0-9]+") %>% as.numeric()
file_versions <- tibble(Filename = fns, Date = fns_date, Version = fns_ver) %>%
  arrange(desc(Date), desc(Version))
file_versions

```

### a7. Big excel data - file versions   
```{r}

# Picks the first 'Filename' in 'file_versions' - this should be the latest 'excel' file:
data_xl_name <- file_versions$Filename[1]
data_xl_lessthans <- readRDS(paste0("Big_excel_table/", data_xl_name))

# for inspection:
if (FALSE){
  data_xl_lessthans %>% 
    select(PARAM, LATIN_NAME, TISSUE_NAME, STATION_CODE, Basis, Yr_2019, EQS_2019, Lt_2019, Trends.2019) %>% 
    View()
}

```



## 2. Plot in document    

```{r}
type <- "line"
```


### Test 1
```{r}
ymax <- 0.45
plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "23B",  "WW"), 
                             eqs_type = "line", xlim = c(1984, 2020), ylim = c(0, ymax))

#plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "53B",  "WW"), 
#                             eqs_type = "line", xlim = c(1982, 2019), ylim = c(0, ymax))

#plot_medians_and_trends(c("QCB", "Mytilus edulis", "Whole soft body", "I133A",  "WW"), 
 #                            eqs_type = "line", xlim = c(1988, 2019), ylim = c(0, 10.5))

#X <- plot_medians_and_trends(c("OCS", "Gadus morhua", "Lever", "30B",  "WW"), 
                        #    eqs_type = type, xlim = c(1990, 2019), eqs_x = 1990, ylim = c(0, 15.0))
#save_trendplot(X, folder)
```

### Test 2
```{r}
plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "23B",  "WWa"), 
                             eqs_type = type, xlim = c(1980, 2019), ylim = c(0, ymax))

```
### Test 3
```{r}
plot_medians_and_trends(c("CR", "Mytilus edulis", "Whole soft body", "57A",  "WW"), 
                             eqs_type = type, xlim = c(1974, 2019), eqs_x = 1980)
```

### Test 4
```{r}
# debugonce(plot_medians_and_trends)
# debugonce(get_plotdata)
plot_medians_and_trends(c("CB118", "Gadus morhua", "Lever", "30B",  "WW"), 
                             eqs_type = type, xlim = c(1984, 2019), ylim = c(0, 800))

```

## 3. Plot to file

### a. Set type and folder  
```{r}
# Make new folder for storing figures
# This needs only to be done once, therefore the commands below are commented out
# dir.create("Figures_401")
# dir.create("Figures_401/Test01")

type <- "line"
folder <- "Figures_401/Til rapporten"
```
#diverse plots til rapport MILKYS2019

```{r}
#X <- plot_medians_and_trends(c("PB", "Mytilus edulis", "Whole soft body", "I304",  "WW"), 
                         #    eqs_type = type, xlim = c(1994, 2019), eqs_x = 1994, ylim = c(0, 0.5))
#save_trendplot(X, folder)

#fig. 4: 15b Hg
X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "15B",  "WWa"), 
                             eqs_type = type, xlim = c(1978, 2019), eqs_x = 1978, ylim = c(0, 0.45))
save_trendplot(X, folder)

#fig. 8
#Hg i blåskjell fra I301. (52A er ikke analyser i 2019) 
X <- plot_medians_and_trends(c("HG", "Mytilus edulis", "Whole soft body", "I301",  "WW"), 
                          eqs_type = type, xlim = c(1989, 2019), eqs_x = 1988, ylim = c(0, 0.035))
save_trendplot(X, folder)

#Fig. 9
X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "13B",  "WW"), 
                            eqs_type = type, xlim = c(1977, 2019), eqs_x = 1977, ylim = c(0, 0.45))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "13B",  "WWa"), 
                            eqs_type = type, xlim = c(1977, 2019), eqs_x = 1977, ylim = c(0, 0.45))
save_trendplot(X, folder)

#Fig. 10 
# Hg 23B og 10B (15B er allerede laget. 10B ble ikke analysert i 2019)
X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "23B",  "WWa"), 
                            eqs_type = type, xlim = c(1979, 2019), eqs_x = 1979, ylim = c(0, 0.45))
save_trendplot(X, folder)

#Fig. 11: 51A ikke analysert i 2019

#Fig. 12 Hg 30B WW + WWa
X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "30B",  "WW"), 
                            eqs_type = type, xlim = c(1977, 2019), eqs_x = 1977, ylim = c(0, 0.45))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "30B",  "WWa"), 
                         eqs_type = type, xlim = c(1977, 2019), eqs_x = 1977, ylim = c(0, 0.45))
save_trendplot(X, folder)

#Fig: 15 CD I304
X <- plot_medians_and_trends(c("CD", "Mytilus edulis", "Whole soft body", "I304",  "WW"), 
                            eqs_type = type, xlim = c(1991, 2019), eqs_x = 1991, ylim = c(0, 0.3))
save_trendplot(X, folder)

```
# mer diverse plots til rapport MILKYS2019

```{r}
#Fig: 17 Pb i 23B og 43B2
X <- plot_medians_and_trends(c("PB", "Gadus morhua", "Lever", "23B",  "WW"), 
                            eqs_type = type, xlim = c(1987, 2019), eqs_x = 1987, ylim = c(0, 0.06))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("PB", "Gadus morhua", "Lever", "43B2",  "WW"), 
                            eqs_type = type, xlim = c(1987, 2019), eqs_x = 1987, ylim = c(0, 0.06))
save_trendplot(X, folder)

#Fig. 18: Pb 45B2
X <- plot_medians_and_trends(c("PB", "Gadus morhua", "Lever", "45B2",  "WW"), 
                            eqs_type = type, xlim = c(2010, 2019), eqs_x = 2012, ylim = c(0, 0.15))
save_trendplot(X, folder)

#Fig. 20 Cu i 15B lever
X <- plot_medians_and_trends(c("CU", "Gadus morhua", "Lever", "15B",  "WW"), 
                            eqs_type = type, xlim = c(1988, 2019), eqs_x = 1988, ylim = c(0, 14.0))
save_trendplot(X, folder)

#Fig. 23 Ag i 15B lever, WW og WWa
X <- plot_medians_and_trends(c("AG", "Gadus morhua", "Lever", "15B",  "WW"), 
                            eqs_type = type, xlim = c(2006, 2019), eqs_x = 2006, ylim = c(0, 1.7))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("AG", "Gadus morhua", "Lever", "15B",  "WWa"), 
                            eqs_type = type, xlim = c(2006, 2019), eqs_x = 2006, ylim = c(0, 1.7))
save_trendplot(X, folder)

#Fig. 26 Ni i 30A
X <- plot_medians_and_trends(c("NI", "Mytilus edulis", "Whole soft body", "30A",  "WW"), 
                            eqs_type = type, xlim = c(2007, 2019), eqs_x = 2007, ylim = c(0, 0.75))
save_trendplot(X, folder)

#Fig. 28 Cr i 30A og 57A
X <- plot_medians_and_trends(c("CR", "Mytilus edulis", "Whole soft body", "30A",  "WW"), 
                            eqs_type = type, xlim = c(2007, 2019), eqs_x = 2007, ylim = c(0, 1.7))
save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("CR", "Mytilus edulis", "Whole soft body", "57A",  "WW"), 
 #                           eqs_type = type, xlim = c(2007, 2019), eqs_x = 2007, ylim = c(0, 1.7))
#save_trendplot(X, folder)

#Fig. 33 VDSI 36G - mangler data 2019
#X <- plot_medians_and_trends(c("VDSI", "Nucella lapillus", "Whole soft body", "36G",  "WW"), 
 #                           eqs_type = type, xlim = c(1988, 2019), eqs_x = 1988, ylim = c(0, 5.0))
#save_trendplot(X, folder)

#Fig. 35 PCB7 i 30B WW og WWa
X <- plot_medians_and_trends(c("CB_S7", "Gadus morhua", "Lever", "30B",  "WW"), 
                            eqs_type = type, xlim = c(1982, 2019), eqs_x = 1982, ylim = c(0, 6200.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("CB_S7", "Gadus morhua", "Lever", "30B",  "WWa"), 
                            eqs_type = type, xlim = c(1982, 2019), eqs_x = 1982, ylim = c(0, 6200.0))
save_trendplot(X, folder)

#Fig. 37 ppDDE i 56A
X <- plot_medians_and_trends(c("DDEPP", "Mytilus edulis", "Whole soft body", "56A",  "WW"), 
                            eqs_type = type, xlim = c(1980, 2019), eqs_x = 1980, ylim = c(0, 51.0))
save_trendplot(X, folder)


```


```{r}
#Fig. 43-44: PBDE i 30B, 23B, 13B og 43B2:

X <- plot_medians_and_trends(c("BDE6S", "Gadus morhua", "Lever", "30B",  "WW"), 
                            eqs_type = type, xlim = c(1989, 2019), eqs_x = 1989, ylim = c(0, 125.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("BDE6S", "Gadus morhua", "Lever", "23B",  "WW"), 
                          eqs_type = type, xlim = c(1989, 2019), eqs_x = 1989, ylim = c(0, 125.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("BDE6S", "Gadus morhua", "Lever", "13B",  "WW"), 
                            eqs_type = type, xlim = c(2007, 2019), eqs_x = 2007, ylim = c(0, 125.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("BDE6S", "Gadus morhua", "Lever", "43B2",  "WW"), 
                          eqs_type = type, xlim = c(2007, 2019), eqs_x = 2007, ylim = c(0, 125.0))
save_trendplot(X, folder)

```
```{r}
#Fig. 55. HBCDA i 71B og 30A

X <- plot_medians_and_trends(c("HBCDA", "Gadus morhua", "Lever", "71B",  "WW"), 
                            eqs_type = type, xlim = c(1997, 2019), eqs_x = 1997, ylim = c(0, 8.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("HBCDA", "Mytilus edulis", "Whole soft body", "30A",  "WW"), 
                          eqs_type = type, xlim = c(1997, 2019), eqs_x = 1997, ylim = c(0, 2.0))
save_trendplot(X, folder)
```


```{r}
#Fig. 59-60: SCCP i 98B1, 98A2 OG 30B
X <- plot_medians_and_trends(c("SCCP", "Gadus morhua", "Lever", "98B1",  "WW"), 
                            eqs_type = type, xlim = c(1997, 2019), eqs_x = 1997, ylim = c(0, 800.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("SCCP", "Mytilus edulis", "Whole soft body", "98A2",  "WW"), 
                          eqs_type = type, xlim = c(1997, 2019), eqs_x = 1997, ylim = c(0, 25.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("SCCP", "Gadus morhua", "Lever", "30B",  "WW"), 
                            eqs_type = type, xlim = c(1997, 2019), eqs_x = 1997, ylim = c(0, 800.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("SCCP", "Gadus morhua", "Lever", "30B",  "WWa"), 
                            eqs_type = type, xlim = c(1997, 2019), eqs_x = 1997, ylim = c(0, 800.0))
save_trendplot(X, folder)
```


```{r}
#Fig. 67 EROD i 30B og 23B  - OBS mangler 2019-data!

X <- plot_medians_and_trends(c("EROD", "Gadus morhua", "Lever", "30B",  "WW"), 
                            eqs_type = type, xlim = c(1993, 2019), eqs_x = 1993, ylim = c(0, 300.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("EROD", "Gadus morhua", "Lever", "23B",  "WW"), 
                            eqs_type = type, xlim = c(1993, 2019), eqs_x = 1993, ylim = c(0, 300.0))
save_trendplot(X, folder)

```

# plots som hadde feil angivelse av trend:

```{r}

X <- plot_medians_and_trends(c("CR", "Mytilus edulis", "Whole soft body", "57A",  "WW"), 
                            eqs_type = type, xlim = c(2003, 2019), eqs_x = 2003, ylim = c(0, 0.8))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("CR", "Mytilus edulis", "Whole soft body", "76A2",  "WW"), 
                            eqs_type = type, xlim = c(2003, 2019), eqs_x = 2003, ylim = c(0, 1.3))
save_trendplot(X, folder)

```
#div HCB
```{r}
X <- plot_medians_and_trends(c("HCB", "Gadus morhua", "Lever", "30B",  "WW"), 
                            eqs_type = type, xlim = c(1988, 2019), eqs_x = 1988, ylim = c(0, 20.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("HCB", "Gadus morhua", "Lever", "15B",  "WW"), 
                            eqs_type = type, xlim = c(1988, 2019), eqs_x = 1988, ylim = c(0, 20.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("HCB", "Gadus morhua", "Lever", "98B1",  "WW"), 
                            eqs_type = type, xlim = c(1988, 2019), eqs_x = 1988, ylim = c(0, 20.0))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("HCB", "Mytilus edulis", "Whole soft body", "I133",  "WW"), 
                            eqs_type = type, xlim = c(1988, 2019), eqs_x = 1988, ylim = c(0, 10.5))
save_trendplot(X, folder)

```
# div QCB og OCS, Men mangler trendsymboler firkant
```{r}
#X <- plot_medians_and_trends(c("QCB", "Gadus morhua", "Lever", "53B",  "WW"), 
         #                   eqs_type = type, xlim = c(1990, 2019), eqs_x = 1990, ylim = c(0, 15.0))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("QCB", "Mytilus edulis", "Whole soft body", "I133",  "WW"), 
                           # eqs_type = type, xlim = c(1994, 2019), eqs_x = 1994, ylim = c(0, 3.0))
#save_trendplot(X, folder)



```
#div plots til MSC
```{r}

#X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "43B2",  "WW"), 
                      #      eqs_type = type, xlim = c(2007, 2019), eqs_x = 2007, ylim = c(0, 0.1))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("HG", "Gadus morhua", "Muskel", "43B2",  "WWa"), 
                        #    eqs_type = type, xlim = c(2007, 2019), eqs_x = 2007, ylim = c(0, 0.1))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("PB", "Mytilus edulis", "Whole soft body", "30A",  "WW"), 
 #                           eqs_type = type, xlim = c(1978, 2019), eqs_x = 1978, ylim = c(0, 2.0))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("PB", "Mytilus edulis", "Whole soft body", "I304",  "WW"), 
 #                           eqs_type = type, xlim = c(1978, 2019), eqs_x = 1978, ylim = c(0, 2.0))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("NI", "Mytilus edulis", "Whole soft body", "76A2",  "WW"), 
          #                  eqs_type = type, xlim = c(2010, 2019), eqs_x = 2010, ylim = c(0, 2.0))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("CR", "Mytilus edulis", "Whole soft body", "76A2",  "WW"), 
                   #         eqs_type = type, xlim = c(2010, 2019), eqs_x = 2010, ylim = c(0, 2.0))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("BDE6S", "Gadus morhua", "Lever", "80B",  "WW"), 
                    #        eqs_type = type, xlim = c(2004, 2019), eqs_x = 2004, ylim = c(0, 125.0))
#save_trendplot(X, folder)

#X <- plot_medians_and_trends(c("BDE6S", "Gadus morhua", "Lever", "80B",  "WWa"), 
                   #         eqs_type = type, xlim = c(2004, 2019), eqs_x = 2004, ylim = c(0, 125.0))
#save_trendplot(X, folder)

#Fig. 33 VDSI 36G - mangler data 2019
#X <- plot_medians_and_trends(c("VDSI", "Nucella lapillus", "Whole soft body", "36G",  "WW"), 
 #                           eqs_type = type, xlim = c(1988, 2019), eqs_x = 1988, ylim = c(0, 5.0))
#save_trendplot(X, folder)

```


### b. Plot figures for Sigurd (15B)
See mail 26.09.2019   
```{r}

X <- plot_medians_and_trends(c("PB", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019))
# X$gg
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("AS", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("CD", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("CO", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019),
                             x_rel = 0.1)
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("CR", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019),
                             x_rel = 0.1)
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("NI", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019),
                             x_rel = 0.1)
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("PB", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("SN", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019))
save_trendplot(X, folder)

X <- plot_medians_and_trends(c("ZN", "Gadus morhua", "Lever", "15B",  "WW"), 
                             eqs_type = type, xlim = c(1989, 2019))
save_trendplot(X, folder)
```

```{r}
i <- 23
```

### c. Plots for Mildir meeting June 2020  
Make a bunch of plots by going through a bumnch of stations  

#### Functions  
```{r}

# dir.create("Figures_401/Mildir_June2020")

# Function to make a data frame with one line per time series
# This contains the info needed to make one time series plot and is used by 'plot_series_number'
get_parameter_data <- function(df){
  
  # Get max value for parameter across stations
  df_max <- df %>%
    group_by(LATIN_NAME, TISSUE_NAME, PARAM, Basis) %>%
    summarise(max_median = max(Median, na.rm = TRUE))
  
  # Get stations and parameters
  parameter_data <- df %>%
    distinct(STATION_CODE, LATIN_NAME, TISSUE_NAME, PARAM, MYEAR, Basis) %>%
    group_by(STATION_CODE, LATIN_NAME, TISSUE_NAME, PARAM, Basis) %>%
    summarise(n_years = n(), min_year = min(MYEAR), max_year = max(MYEAR)) %>%
    # There must be data in 2019, and there must be at least 6 years of data:
    filter(max_year == 2019 & n_years >= 6) %>%  
    # Add an extra column for max value (across station):
    left_join(df_max)
  
  parameter_data

  }

# Function to time series number i, which is line number i 
# in 'data', which has beeen created using 'get_parameter_data'
plot_series_number <- function(i, data, folder, save_plot = TRUE, show_plot = FALSE){
  X <- plot_medians_and_trends(c(data$PARAM[i], data$LATIN_NAME[i], 
                            data$TISSUE_NAME[i], data$STATION_CODE[i],  data$Basis[i]), 
                          eqs_type = "line", 
                          xlim = c(data$min_year[i]-5, 2020),    # Note: years
                          ylim = c(0, data$max_median[i]*1.15))  # Note: max value across stations + 15%
  
  if (save_plot)
    save_trendplot(X, folder)
  
  if (show_plot)
    print(X)
}

# Safe version (meaning that if there is an error, we just continue to the next time series)
plot_series_number_s <- safely(plot_series_number)

# Test
if (FALSE){
  pars_cod_ww <- data_med2 %>%
    filter(STATION_CODE %in% "30B" & Basis == "WW") %>%
    get_parameter_data()
  plot_series_number(1, pars_cod_ww, "Figures_401/Mildir_June2020", 
                     save_plot = FALSE, show_plot = TRUE)
}

```

#### Some cod stations  
```{r}
data_med2 %>%
  distinct(STATION_CODE, TISSUE_NAME, MYEAR) %>%
  group_by(STATION_CODE, TISSUE_NAME) %>%
  summarise(n_years = n(), min_year = min(MYEAR), max_year = max(MYEAR)) %>%
  arrange(desc(n_years))  

folder <- "Figures_401/Mildir_June2020"

#
# Not length-adjusted
#
pars_cod_ww <- data_med2 %>%
  filter(STATION_CODE %in% c("23B","30B","36B","53B","15B","13B","28B","43B2") & 
           Basis == "WW") %>%
  get_parameter_data()

1:nrow(pars_cod_ww) %>%
  purrr::walk(plot_series_number_s, data = pars_cod_ww, folder = folder)

#
# Length-adjusted (metals only)
#
pars_cod_wwa <- data_med2 %>%
  filter(STATION_CODE %in% c("23B","30B","36B","53B","15B","13B","28B","43B2") & 
           Basis == "WWa" &
           nchar(PARAM) == 2) %>%
  get_parameter_data()

1:nrow(pars_cod_wwa) %>%
  purrr::walk(plot_series_number_s, data = pars_cod_wwa, folder = folder)

```
#### Some blue mussel stations  
```{r}

df <- data_med2 %>%
  filter(LATIN_NAME == "Mytilus edulis") %>%
  distinct(STATION_CODE, TISSUE_NAME, MYEAR) %>%
  group_by(STATION_CODE, TISSUE_NAME) %>%
  summarise(n_years = n(), min_year = min(MYEAR), max_year = max(MYEAR)) %>%
  arrange(desc(n_years))  %>%
  filter(max_year == 2019)
# df
df$STATION_CODE

folder <- "Figures_401/Mildir_June2020"

#
# Not length-adjusted, obviously
#
pars_mussel_ww <- data_med2 %>%
  filter(STATION_CODE %in% df$STATION_CODE & 
           Basis == "WW") %>%
  get_parameter_data()

1:nrow(pars_mussel_ww) %>%
  purrr::walk(plot_series_number_s, data = pars_mussel_ww, folder = folder)

```
