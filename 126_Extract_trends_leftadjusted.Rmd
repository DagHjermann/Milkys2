---
title: "126_Extract_trends_leftadjusted"
author: "DHJ"
date: '2022-09-13'
output: html_document
---

- This is sensitive to changes in the saved sereise files ('dat_series' and 'dat_series_trend') on disk (created in script 125)  
- They should be built up from the results files (in the folder given by 'folder_results')  


## 0. Constants (update each year)     

```{r}

last_year <- 2021

folder_results <- paste0("Data/125_results_", last_year, "_02")

indexvars <- c("PARAM", "STATION_CODE", "TISSUE_NAME", "LATIN_NAME")

```

  
## 1. Libraries and functions  

```{r, results='hide', message=FALSE, warning=FALSE}

# install.packages("lubridate")

# General purpose
library(dplyr)
library(tidyr)
library(purrr)
library(mgcv)    #  mgcv_1.8-39
library(ggplot2)

source("125_Calculate_trends_leftadjusted_functions.R")

```


## 2. Data  

### a. Main data and data series  

```{r, collapse=TRUE}

dat_series <- readRDS("Data/125_dat_series.rds")
dat_series_trend <- readRDS("Data/125_dat_series_trend.rds")
dat_all_prep3 <- readRDS("Data/125_dat_all_prep3.rds")


```

### b. Add First_year, Last_year and number of years in the last 10 years  

```{r}

#if (FALSE){
if (T){
# Get First_year  
  
dat_series_extra1 <- dat_all_prep3 %>%
  group_by(Substance.Group, PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME) %>%
  summarise(First_year = min(x), .groups = "drop") 

# Get N_years_10yr (number of years in the last 10 years)
dat_series_extra2 <- dat_all_prep3 %>%
  filter(MYEAR >= (last_year-9)) %>%
  distinct(Substance.Group, PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, x) %>%
  count(Substance.Group, PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, name = "N_years_10yr")

dat_series <- dat_series %>%
  left_join(dat_series_extra1,
            by = c("Substance.Group", "PARAM", "STATION_CODE", "TISSUE_NAME", "LATIN_NAME")) %>%
  left_join(dat_series_extra2,
            by = c("Substance.Group", "PARAM", "STATION_CODE", "TISSUE_NAME", "LATIN_NAME"))

dat_series_trend <- dat_series_trend %>%
  left_join(dat_series_extra1,
            by = c("Substance.Group", "PARAM", "STATION_CODE", "TISSUE_NAME", "LATIN_NAME")) %>%
  left_join(dat_series_extra2,
            by = c("Substance.Group", "PARAM", "STATION_CODE", "TISSUE_NAME", "LATIN_NAME"))
}

```

### c. Check Rule1 and Rule2   

- Rule 1. Time series should be truncated from the left until Nplus/N >= 0.5     
- Rule 2. If a linear/smooth trend is fitted, the first year must be non-censored   
- Get the first value for both of them 
    - If Rule 1 or 2 is kicking in, it always effects the first value
    - if TRUE, the filtering has no effect  
- Are added to 'dat_success' below  

```{r}

df_rule1 <- dat_all_prep3 %>%
  group_by(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME) %>%
  summarise(Rule1 = first(Rule1), .groups = "drop") 

df_rule2 <- dat_all_prep3 %>%
  group_by(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME) %>%
  summarise(Rule2 = first(Rule2), .groups = "drop") 

```


## 3. Check results  

### a. Read files  

```{r}

fns <- dir(folder_results, full.names = TRUE) %>% sort()
result_list <-lapply(fns, readRDS)
cat(length(fns), "files read \n")

# Get file size and time 
fileinfo <- file.info(fns)
# fileinfo

# Extract 'seriesno' from file name (just for checking, see nex chunk)
fileinfo_no <- substr(rownames(fileinfo)[1], nchar(folder_results) + 8, nchar(folder_results) + 11)

```

### b. Extract metadata to dataframe for "successes"  


- jags_finished = TRUE, ok = TRUE: Model fitting done, but did not work for any k values    
- jags_finished = TRUE, ok = FALSE: Model fitting done, but did not work for any k values    
- jags_finished = FALSE, ok = FALSE: Model fitting not done (probably because JAGS was interrupted)      

```{r}

jags_finished <- map_lgl(result_list, ~!is.null(.x$k_values_ok))
ok <- map_lgl(result_list, ~!is.null(.x$DIC))

seriesno <- map_dbl(result_list, "seriesno")
PARAM <- map_chr(result_list, "PARAM")
STATION_CODE <- map_chr(result_list, "STATION_CODE")
TISSUE_NAME <- map_chr(result_list, "TISSUE_NAME")
LATIN_NAME <- map_chr(result_list, "LATIN_NAME")
k_sel <- NA
k_sel[ok] <- map_int(result_list[ok], "k_sel")

dat_success <- data.frame(seriesno, jags_finished, ok,   
                          PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, k_sel) %>%
  # Add Rule1_
  left_join(df_rule1, by = indexvars) %>%
  left_join(df_rule2, by = indexvars) %>%
  # Add N_years, Years_over_LOQ, k_max
  left_join(dat_series_trend %>% 
              select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, N_years, N_years_10yr, Years_over_LOQ, k_max),
            by = indexvars)

# Check that 'fileinfo' is in same order as 'dat_success' - if so, they can simply be joined
check <- seriesno == as.numeric(fileinfo_no)
if (sum(check) == 1){
  dat_success <- dat_success %>%
  bind_cols(fileinfo %>% select(mtime, size))
} else {
  warning("fileinfo not in the same order")
}

```


### c. Check dat_success and dat_series  

- that they have the same order

```{r}

for (var in c("PARAM", "STATION_CODE", "TISSUE_NAME", "LATIN_NAME")){
  print(
    mean(dat_series_trend[[var]] != dat_success[[var]])  
  )
}

```

### d. Statistics  

- VDSI, VDSI/Intersex, "_exloq" parameters, and siloxanes D4-D6 at 19N contains zeros => becomes "-Inf" after log   
- Some (BDE49 at 30A) have k_max = 1 (ie no trend analysis)     
 
```{r}

xtabs(~ok, dat_success)  

cat("\n")
cat("PARAM for those with ok = FALSE :\n")
table(subset(dat_success, !ok)$PARAM)

cat("\n")
cat("Station for PARAM = CB_S7_exloq :\n\n")
xtabs(~ok + STATION_CODE, subset(dat_success, PARAM == "CB_S7_exloq"))

cat("\n")
cat("Station for PARAM = BDE49 :\n\n")
xtabs(~ok + STATION_CODE, subset(dat_success, PARAM == "BDE49"))

cat("\n")
cat("Estimation success vs k_max :\n\n")
xtabs(~ok + k_max, dat_success)

# xtabs(~ok + N_years, dat_success)
# xtabs(~ok + Years_over_LOQ, dat_success)

if (FALSE){
  
  xtabs(~addNA(k_sel) + N_years, dat_success)
  
  xtabs(~addNA(k_sel) + Years_over_LOQ, dat_success)

}

```
### e. Check number of -Inf data  
```{r}

dat_lackof_success <-subset(dat_success, !ok)

dat_lackof_success$n_infin <- map_int(
  dat_lackof_success$seriesno,
  ~sum(is.infinite(extract_raw_data(.x)$y))
)

table(dat_lackof_success$n_infin)  

# xtabs(~PARAM + n_infin, dat_lackof_success)

dat_lackof_success %>%
  filter(n_infin == 0)

```


### e. Plot a single series  
```{r}

# Worked:
tsplot_seriesno(58, folder_results)

# tsplot_seriesno(93, folder_results)

```

## 4. For one compound  

### a. Plot time series, all stations      

```{r}

param <- "MCCP eksl. LOQ"
param <- "CB118"
param <- "HG"

pno <- dat_success %>%
  filter(PARAM == param,
         ok) %>%
  pull(seriesno)

df_modelfit <- map_dfr(pno, extract_modelfit_data, folder = folder_results)
df_rawdata <- map_dfr(pno, extract_raw_data)

ggplot(df_modelfit, aes(x, y)) +
  geom_ribbon(aes(ymin = y_q2.5, ymax = y_q97.5), fill = "lightblue") +
  geom_point(data = df_rawdata %>% filter(!is.na(y))) +
  geom_point(data = df_rawdata %>% filter(!is.na(threshold)), aes(y = threshold), shape = 6) +
  geom_line() +
  facet_wrap(vars(STATION_CODE), scales = "free_y") +
  labs(title = param)

```
### b. Check trend file that goes into the big excel file  

```{r}

# Check trends in big excel file:  
# - use code in script 201 section 7 to get 'check' 
# head(check[c(1, 126:143-9)])

# Columns added:
# Trend p(long)  Detectable % change(long)  First Year(long)  Last Year(long)  No of Years(long) 
# Trend p(short) Detectable % change(short) First Year(short) Last Year(short) No of Years(short) 
# Trends.2021 ("¢/¢" format)  

# Index columns includes Basis, with values:
# DW  DWa   FB  FBa   WW  WWa

if (FALSE){
  c("PARAM", "LATIN_NAME", "TISSUE_NAME", "STATION_CODE", "Basis", 
    "Trend p(long)", "Detectable % change(long)", "First Year(long)", 
    "Last Year(long)", "No of Years(long)", "Trend p(short)", "Detectable % change(short)", 
    "First Year(short)", "Last Year(short)", "No of Years(short)", "Trends.2021")
}

# The trend symbols are made in 'set_symbol' which uses:
# Model_used ("Linear", "Nonlinear"), N_data, P_change, Annual_change (needs only Annual_change >0 or <0)

# up = é      ascii 233  Increasing concentration
# down = ê    ascii 234  Decreasing concentration
# circle = ¢  ascii 162  No significant time trend
# square = §  ascii 167  Too few years to make time trend
# star = «    ascii 171  Too few years with data over LOQ to make time trend

```


### c. Changes for 10 years / entire series       

```{r}

#
# 1. Time series with trends (linear/non-linear)
#

pno_change <- dat_success %>%
  filter(PARAM == param,
         ok) %>%
  # No change for those with no trend (k = 1), so we leave them out:
  filter(k_sel >= 2) %>%
  pull(seriesno)

# test
# extract_difference_data(49, folder_results)

df_with_trend_all <- map_dfr(pno_change, extract_difference_data, folder = folder_results)

df_with_trend <- df_with_trend_all %>%
  group_by(STATION_CODE, TISSUE_NAME, LATIN_NAME) %>%
  mutate(First_year = min(x)) %>%
  # Pick 9 year old data, plus the data from the first year  
  filter(x %in% c(First_year, last_year-9)) %>%
  mutate(
    Trend_string = case_when(
      p < 0.05 & y_mean > 0 ~ "Decreasing",
      p < 0.05 & y_mean < 0 ~ "Increasing",
      TRUE ~ "No change"),
    Trend_type = case_when(
      x >= (last_year-9) ~ "short",
      x < (last_year-9) ~ "long")
  ) %>%
  left_join(
    dat_success %>%
       select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, 
              ok, k_max, k_sel, N_years, N_years_10yr, Years_over_LOQ),
    by = indexvars)

#    Perc_change = round((1-exp(y_mean))/exp(y_mean)*100, 1)
    
#
# 2. Time series without trends (k = 1, or too short series)  
#

df_no_trend_short <- dat_success %>%
  filter(PARAM == param) %>%
  # Pick time series not used in (1)
  anti_join(df_with_trend, by = indexvars) %>%
  left_join(dat_series %>% select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, First_year),
            by = indexvars) %>%
  mutate(
    Trend_string = case_when(
      N_years < 5 ~ "Too few years",
      N_years >= 5 & Years_over_LOQ < 5 ~ "Too few over-LOQ years",
      k_sel %in% 1 ~ "No change",
      TRUE ~ "Estimation failed"),
    Trend_type = "short",
    y_mean = 0
  )

# Add extra (but almost identical) data set for long series (older than 9 years)
df_no_trend_long <- df_no_trend_short %>%
  filter(First_year < (last_year-9)) %>%
  mutate(
    Trend_type = "long",
    y_mean = 0)

#
# 3. Combine time series with and without trends 
#
df_trend <- bind_rows(
  df_with_trend,
  df_no_trend_short,
  df_no_trend_long) %>%
  mutate(
    Perc_change = round((1-exp(y_mean))/exp(y_mean)*100, 1),
    Trend_symbol = case_when(
      is.na(Trend_string) ~ "-",
      Trend_string %in% "Increasing" ~ "é",
      Trend_string %in% "Decreasing" ~ "ê",
      Trend_string %in% "No change" ~ "¢",
      Trend_string %in% "Too few years" ~ "§",
      Trend_string %in% "Too few over-LOQ years" ~ "«")
    ) %>%
  select(
    PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, 
    x, y_mean, y_sd, p, p_category, First_year, 
    Trend_string, Trend_symbol, Perc_change, Trend_type,
    ok, k_max, k_sel, N_years, Years_over_LOQ)

#
# 4. Put them on wide format (separate columns for short and long) 
#
df_trend_wide <- df_trend %>%
  select(
    PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, 
    Trend_type, Trend_string, Trend_symbol, Perc_change, p, First_year) %>%
  tidyr::pivot_wider(
    names_from = Trend_type, 
    values_from = c(Trend_string, Trend_symbol, Perc_change, p, First_year)) %>% 
  mutate(
    Basis = "WW",
    First_year_short = ifelse(
      First_year_short < (last_year-9), (last_year-9), First_year_short),
    Trend_symbol_long = ifelse(is.na(Trend_symbol_long), "-", Trend_symbol_long),
    Trend_symbol_short = ifelse(is.na(Trend_symbol_short), "-", Trend_symbol_short),
    Trend_symbol = paste0(Trend_symbol_long, "/", Trend_symbol_short)
  )
  

# ?sprintf

```


## 5. For all: Extract trends (long- and short-term)   

- Almost all code is extremely similar to code for one parameter, just removed the 'filter(PARAM == param) ' two places  

### a. All with trend: get difference data       
```{r}

pno_change <- dat_success %>%
  filter(ok) %>%
  # No change and no difference data for those with no trend (selected k = 1):
  filter(k_sel >= 2) %>%
  pull(seriesno)

# test
# extract_difference_data(49, folder_results)

df_with_trend_all <- map_dfr(pno_change, extract_difference_data, folder = folder_results)

```

### b. All with trend: Extract up/down trends     
```{r}

df_trend_long <- df_with_trend_all %>%
  group_by(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME) %>%
  mutate(Year_pick = min(x)) %>%
  filter(Year_pick < (last_year-9)) %>%
  filter(x == Year_pick) 

df_trend_short <- df_with_trend_all %>%
  group_by(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME) %>%
  mutate(
    Year_pick = max((last_year-9), min(x))) %>%
  filter(x == Year_pick)

# Combine
df_trend_worked <- bind_rows(
  df_trend_long %>% ungroup() %>% mutate(Trend_type = "long"),
  df_trend_short %>% ungroup() %>% mutate(Trend_type = "short")
) %>%
  mutate(
    Trend_string = case_when(
      p < 0.05 & y_mean > 0 ~ "Decreasing",
      p < 0.05 & y_mean < 0 ~ "Increasing",
      TRUE ~ "No change")
  ) %>%
  left_join(
    dat_success %>%
       select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, 
              ok, k_max, k_sel, N_years, N_years_10yr, Years_over_LOQ),
    by = indexvars) %>%
  left_join(
    dat_series %>%
       select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, First_year, Trend_model),
     by = indexvars)

```

### c. The ones with k = 1 (flat)  
```{r}

df_trend_flat_short <- dat_success %>%
  select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, 
              ok, k_max, k_sel, N_years, N_years_10yr, Years_over_LOQ) %>%
  filter(ok, 
         k_sel == 1) %>%
  mutate(
    Trend_string = case_when(
      N_years < 5 ~ "Too few years",
      N_years >= 5 & Years_over_LOQ < 5 ~ "Too few over-LOQ years",
      Years_over_LOQ >= 5 ~ "No trend"),
    Trend_type = "short") %>%
  left_join(
    dat_series %>%
       select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, First_year, Last_year, Trend_model),
     by = indexvars) 

df_trend_flat_long <- df_trend_flat_short %>%
  filter(First_year < (last_year-9)) %>%
  mutate(Trend_type = "long")


```

### d. The ones that failed  
```{r}

df_trend_failed_short <- dat_success %>%
  select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, 
              ok, k_max, k_sel, N_years, N_years_10yr, Years_over_LOQ) %>%
  filter(!ok) %>%
  mutate(
    Trend_string = case_when(
      N_years < 5 ~ "Too few years",
      N_years >= 5 & Years_over_LOQ < 5 ~ "Too few over-LOQ years",
      Years_over_LOQ >= 5 ~ "Estimation failed"),
    Trend_type = "short") %>%
  left_join(
    dat_series %>%
       select(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, First_year, Last_year, Trend_model),
     by = indexvars) 

df_trend_failed_long <- df_trend_failed_short %>%
  filter(First_year < (last_year-9)) %>%
  mutate(Trend_type = "long")

```

### e. The ones with "no model" 
```{r}

df_trend_toofew_short <- dat_series %>%
  filter(Trend_model %in% "No model") %>%
    mutate(
    Trend_string = case_when(
      N_years < 5 ~ "Too few years",
      N_years >= 5 & Years_over_LOQ < 5 ~ "Too few over-LOQ years"),
    Trend_type = "short"
  )

df_trend_toofew_long <- df_trend_toofew_short %>%
  filter(First_year < (last_year-9)) %>%
  mutate(Trend_type = "long")

```

### f. Combine  
```{r}

df_trend <- bind_rows(
  df_trend_worked %>% mutate(dataset = 1),
  df_trend_flat_long %>% mutate(dataset = 2), 
  df_trend_flat_short %>% mutate(dataset = 3),
  df_trend_failed_long %>% mutate(dataset = 4), 
  df_trend_failed_short %>% mutate(dataset = 5),
  df_trend_toofew_long %>% mutate(dataset = 6), 
  df_trend_toofew_short %>% mutate(dataset = 7)
  )

check1 <- df_trend %>%
  add_count(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, Trend_type) %>%
  arrange(PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, Trend_type) %>%
  filter(n > 1)

if (nrow(check1) > 0){
  stop("Some series occur more than once!")
}

check2 <- dat_series %>%
  anti_join(df_trend, by = indexvars)

if (nrow(check1) > 0){
  stop("Some series not included in df_trend!")
}

check3 <- df_trend %>%
  filter(is.na(Trend_string))

if (nrow(check3) > 0){
  stop("Some series lack 'Trend_string'!")
} 

# If we got this far...
df_trend <- df_trend %>% select(-dataset)

```


### g. Add trend symbols and percent change    

- Check trends in big excel file:  
```
# - use code in script 201 section 7 to get 'check' 
head(check[c(1, 126:143-9)])

# Columns needed:
#   "PARAM", "LATIN_NAME", "TISSUE_NAME", "STATION_CODE", "Basis", 
#   "Trend p(long)", "Detectable % change(long)", "First Year(long)", "Last Year(long)", "No of Years(long)", 
#   "Trend p(short)", "Detectable % change(short)", "First Year(short)", "Last Year(short)", "No of Years(short)", 
#   "Trends.2021"

# Index columns includes Basis, with values:
# DW  DWa   FB  FBa   WW  WWa

```

Symbols: 

- up = é      ascii 233  Increasing concentration
- down = ê    ascii 234  Decreasing concentration
- circle = ¢  ascii 162  No significant time trend
- square = §  ascii 167  Too few years to make time trend
- star = «    ascii 171  Too few years with data over LOQ to make time trend  

```{r}

df_trend <- df_trend %>%
  mutate(
    Perc_change = round((1-exp(y_mean))/exp(y_mean)*100, 1),
    D_year = last_year - First_year,
    Perc_annual = round((1-exp(y_mean/D_year))/exp(y_mean)*100, 1),
    Perc_annual_lo = round((1-exp(y_q2.5/D_year))/exp(y_mean)*100, 1),
    Perc_annual_hi = round((1-exp(y_q97.5/D_year))/exp(y_mean)*100, 1),
    Trend_symbol = case_when(
      is.na(Trend_string) ~ "x",
      Trend_string %in% "Increasing" ~ "é",
      Trend_string %in% "Decreasing" ~ "ê",
      Trend_string %in% "No change" ~ "¢",
      Trend_string %in% "Too few years" ~ "§",
      Trend_string %in% "Too few over-LOQ years" ~ "«")
    )

check1 <- df_trend %>%
  filter(is.na(First_year))

if (nrow(check1) > 0){
  stop("Some series lack 'First_year'")
}

```


### h. Put them on wide format (separate columns for short and long)   

```{r}
   
df_trend_wide <- df_trend %>%
  select(
    PARAM, STATION_CODE, TISSUE_NAME, LATIN_NAME, 
    Trend_type, Trend_string, Trend_symbol, Perc_change, p, First_year, Last_year, N_years, N_years_10yr) %>%
  tidyr::pivot_wider(
    names_from = Trend_type, 
    values_from = c(Trend_string, Trend_symbol, Perc_change, p, First_year, Last_year)) %>% 
  mutate(
    First_year_short = ifelse(
      First_year_short < (last_year-9), (last_year-9), First_year_short),
    Trend_symbol_long = ifelse(is.na(Trend_symbol_long), "x", Trend_symbol_long),
    Trend_symbol_short = ifelse(is.na(Trend_symbol_short), "x", Trend_symbol_short),
    Trend_symbol = paste0(Trend_symbol_long, "/", Trend_symbol_short)
  ) %>%
  mutate(
    Basis = "WW", .after = "LATIN_NAME")

```


## 6. Save  

```{r}

saveRDS(df_trend, "Data/126_df_trend_2021.rds")
saveRDS(df_trend_wide, "Data/126_df_trend_wide_2021.rds")
saveRDS(dat_all_prep3, "Data/126_dat_all_prep3_2021.rds")
saveRDS(dat_series_trend, "Data/126_dat_series_trend_2021.rds")
saveRDS(dat_success, "Data/126_dat_success_2021.rds")

if (FALSE){
  # For reading back
  df_trend <- readRDS("Data/126_df_trend_2021.rds")
  df_trend_wide <- readRDS("Data/126_df_trend_wide_2021.rds")
  dat_all_prep3 <- readRDS("Data/126_dat_all_prep3_2021.rds")
  dat_series_trend <- readRDS("Data/126_dat_series_trend_2021.rds")
  dat_success <- readRDS("Data/126_dat_success_2021.rds")
}

```


## 7. Various checking   

### Some that failed  
```{r}

# Contains -Inf 
tsplot_param("CB_S7_exloq", "10A2", folder = folder_results)
tsplot_param("D5", "19B", folder = folder_results)

# Short series (n = 4)
tsplot_param("BDE49", "30A", folder = folder_results)

# No apparent reason for failure?
tsplot_param("CB101", "30B", folder = folder_results)
# extract_raw_data(get_seriesno("CB101", "30B")) %>% View()

```

### Some that worked
```{r}

tsplot_param("BDE47", "I023", folder = folder_results)
tsplot_param("HG", "98B1", folder = folder_results)
tsplot_param("MCCP eksl. LOQ", "28B", folder = folder_results)  

```



