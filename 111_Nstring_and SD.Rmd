---
title: "111_Nstring_and_SD"
output: html_document
---

Creates 'N_string' and 'SD' (standard deviation) for last year and current year  
- Uses the same input files as script 110, and in a way orks in the same way (summarises sample-level data into one line per year/station/tissue/parameter)     
- Output is used by '201_Make_big_excel_file.Rmd'  

## 0. Current year  
The year of the last data

```{r}
last_year <- 2019
lastyear_projectname <- "MILKYS2019"
secondlastyear_projectname <- "MILKYS2018"

```


## 1. Packages
```{r, message=FALSE, warning=FALSE, results='hide'}

library(readxl)
library(tidyr)

#
# Dropping dtplyr (it only saves 20 seconds or so in this script)
#
# install.packages("dtplyr")
# library(data.table)
# library(dtplyr)

library(dplyr, warn.conflicts = FALSE)
library(purrr)
library(safejoin)

source("111_Nstring_and SD_functions.R")


```


## 2. Data

### Main data  
Read and reformat the most recent data (by default)  
```{r, collapse=TRUE}

files <- list_files("Data", pattern = "109_adjusted_data")
data_list <- read_rds_file(folder = "Data", 
                          files, 
                          filenumber = 1, 
                          get_date = TRUE,
                          time_since_modified = TRUE)

data_all <- data_list$data
file_date <- data_list$file_date   # will be used in part 10, when we save the resulting file

```



### Fixing   
Same as in script 110 
```{r}

# Fixing station 227G1 and 227G2 (shall count as 227G) 
sel <- data_all$STATION_CODE %in% c("227G1","227G2")
# xtabs(~MYEAR, data_all[sel,])
data_all$STATION_CODE[sel] <- "227G"
cat("Fixing station 227G1 and 227G2 (shall count as 227G) \n")
cat("- STATION_CODE changed for", sum(sel), "rows \n")


# Fixing station 36A and 36A1 (36A1 shall count as 36A) 
sel <- data_all$STATION_CODE %in% "36A1"
# xtabs(~MYEAR, data_all[sel,])
data_all$STATION_CODE[sel] <- "36A"
cat("Fixing station 36A and 36A1 (36A1 shall count as 36A) \n")
cat("- STATION_CODE changed for", sum(sel), "rows \n")

```

### Labware data for this year  
Uses the most recent data (by default)    
```{r}

# Penultimate year:
files <- list_files(
  folder = "Input_data",
  pattern = paste0("Labware_samples_", last_year-1))
df_samples_labware_raw_previous <- read_rds_file(
  folder = "Input_data",
  files, 
  filenumber=1)

# Ultimate year:
cat("\n")
files <- list_files(
  folder = "Input_data",
  pattern = paste0("Labware_samples_", last_year))
df_samples_labware_raw_last <- read_rds_file(
  folder = "Input_data",
  files, 
  filenumber=1)

# Combine
df_samples_labware_raw <- bind_rows(
  df_samples_labware_raw_previous %>% mutate(MYEAR = last_year-1),
  df_samples_labware_raw_last %>% mutate(MYEAR = last_year)
)

cat("\n")
cat("Combined labware file - lines per year: \n")
xtabs(~MYEAR, df_samples_labware_raw)

```


### Fix BIOTA_SAMPLENO = 0  
```{r}

# xtabs(~BIOTA_SAMPLENO, df_samples_labware_raw)

sel <- df_samples_labware_raw$BIOTA_SAMPLENO == 0
cat(sum(sel), "samples have BIOTA_SAMPLENO == 0 \n")

# All are BI-Galle
cat("\nTissue of samples with BIOTA_SAMPLENO == 0: \n")
xtabs(~TISSUE, df_samples_labware_raw[sel,])

# Exctract sample from DESCRIPTION

# First, remove AQUAMONITOR_CODE part from the DESCRIPTION strings
description_clipped <- df_samples_labware_raw$DESCRIPTION
line_numbers <- which(sel)

# Loop through each line and remove AQUAMONITOR_CODE part
for (i in line_numbers){
  description_clipped[i] <- sub(
    df_samples_labware_raw$AQUAMONITOR_CODE[i], 
    replacement = "",
    x = description_clipped[i])
}

# for checking the result
if (FALSE){
  # The clipped descriptions
  description_clipped[sel]
  # Extract number characters
  description_clipped[sel] %>%
    stringr::str_extract("[0-9]+")
}

# Extract number characters
df_samples_labware_raw$BIOTA_SAMPLENO[sel] <- description_clipped[sel] %>%
  stringr::str_extract("[0-9]+") %>%
  as.numeric()

cat("\n")
cat("Values of BIOTA_SAMPLENO after fix (should no zeros or NAs): \n")
xtabs(~addNA(BIOTA_SAMPLENO), df_samples_labware_raw)



```


## 3. Get N_string (sample size last year)   
Example: N_string "8 (6-3)" means that:   
- number of samples (pooled or unpooled) = 8   
- number of pooled samples = 6  
- maximum number of individuals per pooled sample = 3   

### Get number of individuals per pooled sample  
Uses function 'number_of_ind()' to get number of individuals per pooled sample   
```{r}

# Get number of individuals per pooled sample
# Use df_samples (table from LABWARE) 
# NOTE: Differs from code in 201 by extracting MYEAR and using it in grouping/summarising  
df_samples_labware <- df_samples_labware_raw %>%
  rename(STATION_CODE = AQUAMONITOR_CODE,
         LATIN_NAME = SPECIES,
         SAMPLE_NO2 = BIOTA_SAMPLENO
  ) %>%
  mutate(
    TISSUE_NAME = stringr::str_sub(TISSUE, start = 4),
    No_individuals = number_of_ind(X_BULK_BIO)
  ) %>%    # get number of individuals per pooled sample
  select(MYEAR, STATION_CODE, LATIN_NAME, TISSUE_NAME, SAMPLE_NO2, X_BULK_BIO, No_individuals) %>%
  group_by(MYEAR, STATION_CODE, LATIN_NAME, TISSUE_NAME, SAMPLE_NO2) %>%
  summarise_all(first) %>%
  ungroup() %>%
  # Special case for molluscs, which have no X_BULK_BIO value:
  mutate(No_individuals = case_when(
    LATIN_NAME %in% "Mytilus edulis" ~ 50,
    LATIN_NAME %in% c("Littorina littorea", "Nucella lapillus") ~ 30,
    is.na(No_individuals) ~ 1,     # in the case of fish, no X_BULK_BIO value means 1 individual
    TRUE ~ No_individuals)
  )

xtabs(~is.na(No_individuals) + MYEAR, df_samples_labware)

```
### Fixing STATION_CODE     
Same as in above (and in script 110) 
```{r}

# Fixing station 227G1 and 227G2 (shall count as 227G) 
sel <- df_samples_labware$STATION_CODE %in% c("227G1","227G2")
# xtabs(~MYEAR, data_all[sel,])
df_samples_labware$STATION_CODE[sel] <- "227G"
cat("Fixing station 227G1 and 227G2 (shall count as 227G) \n")
cat("- STATION_CODE changed for", sum(sel), "rows \n")


# Fixing station 36A and 36A1 (36A1 shall count as 36A) 
sel <- df_samples_labware$STATION_CODE %in% "36A1"
# xtabs(~MYEAR, data_all[sel,])
df_samples_labware$STATION_CODE[sel] <- "36A"
cat("Fixing station 36A and 36A1 (36A1 shall count as 36A) \n")
cat("- STATION_CODE changed for", sum(sel), "rows \n")

```

### Raw data with 'No_individuals' (info on pooled sample) added 
```{r}

df_samples <- data_all %>%
  filter(MYEAR %in% c(last_year-1, last_year)) %>%
  safe_left_join(subset(df_samples_labware, select = -X_BULK_BIO),
                 by = c("MYEAR", "STATION_CODE", "LATIN_NAME", "TISSUE_NAME", "SAMPLE_NO2"),
                 na_matches = "never",
                 check = "BCVm") %>%
  mutate(No_individuals = case_when(
    PARAM %in% c("ALAD", "EROD", "D4", "D5", "D6") ~ 1,  # these parameters are from single cod
    LATIN_NAME %in% "Mytilus edulis" ~ 50,    # industry blue mussel stations I964, I965, I969
    TRUE ~ No_individuals)
  )

xtabs(~is.na(No_individuals), df_samples)
xtabs(~is.na(No_individuals) + MYEAR, df_samples)  

```

### Check data with 'No_individuals' (info on pooled sample) added   
Only left without are some very pretty strange parameters in cod liver in two stations   
```{r}

df_samples %>%
  filter(is.na(No_individuals)) %>%
  xtabs(~STATION_CODE + MYEAR, .)

df_samples %>%
  filter(is.na(No_individuals) & LATIN_NAME == "Gadus morhua") %>%
  xtabs(~STATION_CODE + PARAM, .)

if (FALSE){
  df_samples %>%
    filter(is.na(No_individuals)) %>%
    View()
}

```

### Make N_string
```{r}

# df_numbers - contains 'N_string' which will be added to data by left-join 
#  - equals raw data summarised per station x parameter
df_numbers <- df_samples %>%
  filter(!is.na(VALUE_WW)) %>%
  group_by(MYEAR, STATION_CODE, LATIN_NAME, TISSUE_NAME, PARAM) %>%
  summarise(
    N = n(),
    N_pooled = sum(No_individuals > 1),
    Max_ind = max(No_individuals),
    .groups = "drop"
  ) %>%
  mutate(
    N_string = paste0(N, " (", N_pooled, "-", Max_ind, ")")  # Make string
  )

if (FALSE){
  View(df_numbers)
  
  sel <- grepl("NA", df_numbers$N_string)
  View(df_numbers[sel,])
  
  table(is.na(df_numbers$N_string))
  table(substr(addNA(df_numbers$N_string), 1, 1))
  table(df_numbers$N_string)
}

sel <- grepl("NA", df_numbers$N_string)
cat(sum(sel), "N_string contains 'NA' \n")


```

### Imposex and intersex - TO INCLUDE LATER?
```{r}


#
# Imposex and intersex - TO INCLUDE LATER   
#
if (FALSE){
  data_imposex <- readRDS("Data/32_data_imposex.rds")
  
  df_numbers_imposex <- data_imposex %>%
    filter(Sex %in% "f" & PARAM %in% c("VDSI","Intersex") & !is.na(VALUE_WW)) %>%
    group_by(STATION_CODE) %>%
    summarise(Max_ind = n()) %>%
    ungroup() %>%
    mutate(
      N_string_new = paste0(1, " (", 1, "-", Max_ind, ")")
    ) %>%
    select(STATION_CODE, N_string_new)
  
  #
  # Replace N_string values for imposex and intersex 
  #
  df_numbers <- df_numbers %>%
    safe_left_join(df_numbers_imposex, 
                   by = c("STATION_CODE"),
                   na_matches = "never",
                   check = "BCV") %>%
    mutate(N_string = ifelse(is.na(N_string_new), N_string, N_string_new)) %>%
    select(-N_string_new)
}
# end of "Imposex and intersex" part

```


## 5. Save  
```{r}

filename <- paste0("Data/111_Nstring_and_sd_updated_", file_date, ".rds")

saveRDS(xxxxxx, filename)

cat("Data of N_string and SD saved as: \n")
cat(" ", filename, "\n")

```




