---
title: "Report for parameter (430)"
author: "DHJ"
date: "18.08.2022"
params:
  param: "HG"
output: 
  html_document:
  keep_md: false
toc: true
toc_float: true
---

# `r params$param` (`r params$tissue` in `r params$species`, `r params$basis`)
   
```{r 01_settings, include=FALSE}

current_year <- 2021
knitr::opts_chunk$set(echo = FALSE, results = 'hold')

```

```{r 02_packages, include=FALSE}

library(dplyr)
# library(tidyr)
library(ggplot2)
library(lubridate)
library(flextable)
# library(glue)
library(readxl)
library(purrr)
library(glue)
# library(leftcensored)   # DHJ's package (https://github.com/DagHjermann/leftcensored)
library(scico)            # colour palettes incl. "Vik" (https://github.com/thomasp85/scico)

library(ggiraph)
library(cowplot)

# library(safejoin) # https://github.com/moodymudskipper/safejoin

# source("01_Get_chemical_data_NIVAbasen_functions.R")  # for get_standard_parametername()
# source("824_Report_for_scientists_functions.R")
source("420_Report_paramgroup_functions.R", encoding = "UTF-8")
source("125_Calculate_trends_leftadjusted_functions.R")
source("431_Report_parameter_functions.R")

```

## Medians and trends    

```{r 03_medians_data1}

#
# Get data 
#

# debugonce(get_data_medians)
dat_temporary <- list(
  get_data_medians(param = params$param, 
                   species = "Gadus morhua",
                   tissue = ifelse(params$param %in% "HG", "Muskel", "Lever"),
                   basis = ifelse(params$param %in% "HG", "WWa", "WW"), 
                   include_year = current_year),
  get_data_medians(param = params$param, 
                   species = "Somateria mollissima",
                   tissue = "Blod",
                   basis = "WW", 
                   include_year = current_year),
  get_data_medians(param = params$param, 
                   species = "Somateria mollissima",
                   tissue = "Egg",
                   basis = "WW", 
                   include_year = current_year),
  get_data_medians(param = params$param, 
                   species = "Mytilus edulis",
                   tissue = "Whole soft body",
                   basis = "WW", 
                   include_year = current_year)
)

str(dat_temporary, 1)

# levels(dat_temporary[[1]]$Station)
# levels(dat_temporary[[2]]$Station) 

```

```{r 03_medians_data2}

#
# Combine cod and eider duck as one group  
#

eider_blood <- "19N Kongsfjorden (eider duck blood)"
eider_egg <- "19N Kongsfjorden (eider duck egg)"

#
# Make 'dat_medians_list'  
#

dat_medians_list <- list()

# List element 1: cod and eider duck

dat_medians_list[[1]] <- bind_rows(
  dat_temporary[[1]],
  dat_temporary[[2]] %>% mutate(Station = eider_blood),
  dat_temporary[[3]] %>% mutate(Station = eider_egg)
)

dat_medians_list[[1]]$Station <- factor(dat_medians_list[[1]]$Station, 
                                        levels = c(levels(dat_temporary[[1]]$Station), eider_blood, eider_egg))

# levels(dat_medians_list[[1]]$Station)

# List element 2 = blue mussel

dat_medians_list[[2]] <- dat_temporary[[4]]

```


```{r 04_medians_plot, fig.width=10, fig.height=8, warning=FALSE}

proref_cols <- c(RColorBrewer::brewer.pal(6, "Blues")[5:2],
                 RColorBrewer::brewer.pal(6, "YlOrRd")[1:5])
  
col_func <- function(x){cols[x]}

startyr <- 2012

# Trick to avoid red frames also in legend:
# - put 'fill = Proref_ratio_cut' in aes of the first geom_tile (not in the aes of ggplot)
# - set 'alpha = 0' so there is no fill in the EQS tiles 

gg_tile_list <- list()

speciesgroup_txt <- c("cod and eider duck", "blue mussel")

for (speciesgroup in 1:2){
  
  dat_medians <- dat_medians_list[[speciesgroup]]
  
  gg_tile_list[[speciesgroup]] <- ggplot(dat_medians, aes(MYEAR, Station)) +
    geom_tile(aes(fill = Proref_ratio_cut)) + 
    geom_tile(data = subset(dat_medians, Above_EQS %in% "Over"),
              color = "red", size = 1, height = 0.9, width = 0.9, alpha = 0) +
    geom_text(aes(label = round(Value, 3)), nudge_y = -0.1, size = 3) +
    geom_text(aes(label = LOQ_label), size = 3, nudge_y = 0.3) +
    scale_fill_manual("Proref ratio", values = proref_cols) +
    scale_color_manual(values = c("red", "white")) +
    scale_alpha_manual(values = c(1, 0)) +
    scale_x_continuous(breaks = seq(startyr, 2020, 2), 
                       limits = c(startyr-0.5, current_year+0.5)) +
    theme_bw() +
    guides(colour = "none") +
    labs(
      title = paste0(dat_medians$Parameter.Name[1], " in ", speciesgroup_txt[[speciesgroup]]),
      x = "Year", y = "")
  
}

if (FALSE){
  gg_tile_list[[1]]
  gg_tile_list[[2]]
}

```

```{r 05_trends_data1}

dat_trends_plot_list <- purrr::map(
  dat_medians_list, 
  get_data_trends, include_year = current_year
)

# table(addNA(dat_trends_plot_list[[1]]$Station))
# levels(dat_trends_plot_list[[1]]$Station)
# View(dat_trends_plot_list[[1]])

```

```{r 05_trend_create_plots}

gg_trends_list <- list()


for (speciesgroup in 1:2){
  
  gg_trends_list[[speciesgroup]] <- c("long", "short") %>%
    map(
      ~ggplot(dat_trends_plot_list[[speciesgroup]] %>% filter(Trend_type %in% .x),
              aes(x = Station, y = Perc_annual)) +
        geom_linerange(aes(ymin = Perc_annual_lo, ymax = Perc_annual_hi, colour = Trend_color), size = 1) +
        geom_point(aes(fill = Trend_color, shape = Trend_color), colour = "black", size = 3) +
        scale_colour_manual(values = trend_colours, drop = FALSE) +
        scale_fill_manual(values = trend_colours, drop = FALSE) +
        scale_shape_manual(values = trend_shapes, drop = FALSE) +
        geom_hline(yintercept = 0, color = "grey30") +
        geom_label(aes(y = 0, label = Trend_text), fill = "white", color = "blue3", 
                   label.size = 0, size = 3) +
        coord_flip(ylim = y_ran) +
        labs(title = glue("Trend ({.x}-term)"), y = "") +
        theme_bw() 
    )
  
}


if (FALSE){
  gg_trends_list[[1]][[1]]
  gg_trends_list[[1]][[2]]
  gg_trends_list[[2]][[1]]
  gg_trends_list[[2]][[2]]
}


```

```{r 06_combine_plots, fig.width=10, fig.height=8, warning=FALSE}

ggcomb_list <- list()

for (speciesgroup in 1:2){
  
  ggcomb_list[[speciesgroup]] <- cowplot::plot_grid(
    gg_tile_list[[speciesgroup]] + theme(legend.position = "none"), 
    gg_trends_list[[speciesgroup]][[1]] + 
      theme(axis.title.y = element_blank(),
            axis.text.y = element_blank(),
            legend.position = "none"), 
    gg_trends_list[[speciesgroup]][[2]] + 
      theme(axis.title.y = element_blank(),
            axis.text.y = element_blank()), 
    nrow = 1, ncol = 3,
    rel_heights = 3,
    rel_widths = c(2.7, 0.75, 1.25)
  )
  
  ggcomb_legend <- cowplot::get_legend(gg_tile_list[[speciesgroup]])
  
  # filename <- glue::glue("Figures/431/{params$param}_{tissue}_combo.png")
  # ggsave(filename, ggcomb, width = 14, height = 8, dpi = 200)
  # 
  # filename <- glue::glue("Figures/431/{params$param}_{tissue}_combo_legend.png")
  # ggsave(filename, ggdraw(ggcomb_legend), width = 2, height = 4, dpi = 200)
  
}

if (FALSE){
  ggcomb_list[[1]]
}

```

```{r 05_trend_plot_legend}

ggdraw(ggcomb_legend)

```


```{r 06_ratio_data_1}  

# debugonce(get_data_raw)  
dat_raw <- get_data_raw("HG", "Gadus morhua", "Muskel", "WWa", 2021)  

dat_last_year_1 <- get_data_medians("HG", "Gadus morhua", "Muskel", "WWa", 2021) %>%
  filter(MYEAR %in% current_year)

dat_to_add <- dat_raw %>%
  filter(MYEAR %in% current_year & !is.na(Value)) %>%
  group_by(PARAM, LATIN_NAME, TISSUE_NAME, STATION_CODE, Basis) %>%
  summarise(
    Value_min = quantile(Value, probs = 0.25),
    Value_max = quantile(Value, probs = 0.75), .groups = "drop")

dat_last_year_2 <- dat_last_year_1 %>%
  left_join(dat_to_add, by = c("PARAM", "LATIN_NAME", "TISSUE_NAME", "STATION_CODE", "Basis"))

levels(dat_last_year_2$Station)


```
```{r}

#
# Median data  
#
dat_medians_lastyear <- dat_last_year_2 %>% 
  ungroup() %>%
  mutate(
    Proref_ratio_min = Value_min/Proref,
    Proref_ratio_max = Value_max/Proref,
    EQS_ratio_min = Value_min/EQS,
    EQS_ratio_max = Value_max/EQS,
    Proref_tooltip = paste0(
      "Conc.: ", Value, " (Min-max: ", Value_min, "-", Value_max, ")\n",
      "Ratio: ", Proref_ratio, " (Min-max: ", Proref_ratio_min, "-", Proref_ratio_max, ")\n"),
    EQS_tooltip = paste0(
      "Conc.: ", Value, " (Min-max: ", Value_min, "-", Value_max, ")"),
    Station = factor(Station, levels = rev(levels(dat_last_year_2$Station)))
  ) 


```

```{r}

ggplot(dat_medians_lastyear, aes(Station, EQS_ratio)) +
  geom_point() +
  geom_linerange(aes(ymin = EQS_ratio_min, ymax = EQS_ratio_max)) +
  theme_bw() +
  theme(legend.title = element_blank()) +
  ggeasy::easy_rotate_x_labels(angle = -45) 


```

